<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>YouTube Video Downloader</h1>
        
        {% if error %}
        <div class="error">{{ error }}</div>
        {% endif %}
        
        <form method="POST" id="download-form">
            <input type="text" name="url" id="video-url" placeholder="Cole o link do YouTube aqui..." required>
            <button type="button" id="check-video">Verificar Vídeo</button>
            
            <div id="resolution-container" style="display: none; margin-top: 15px;">
                <div class="video-info">
                    <img id="thumbnail" src="" alt="Thumbnail" style="max-width: 200px; margin-bottom: 10px;">
                    <h3 id="video-title">Título do Vídeo</h3>
                </div>
                <label for="resolution">Escolha a resolução:</label>
                <select name="resolution" id="resolution-select">
                    <!-- As opções serão preenchidas dinamicamente -->
                </select>
                <button type="submit" id="download-button">Baixar Vídeo</button>
            </div>
        </form>
        
        <div id="progress-container" style="display: none; margin-top: 20px;">
            <div class="progress-label">Baixando: <span id="progress-title">...</span></div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="download-progress"></div>
            </div>
            <div class="progress-info">
                <span id="progress-percentage">0%</span>
                <span id="progress-speed">0 MB/s</span>
            </div>
        </div>
        
        <div class="instructions">
            <h3>Como usar:</h3>
            <ol>
                <li>Copie o URL do vídeo do YouTube</li>
                <li>Cole no campo acima e clique em "Verificar Vídeo"</li>
                <li>Escolha a resolução desejada</li>
                <li>Clique em "Baixar Vídeo"</li>
            </ol>
        </div>
    </div>

    <script>
        $(document).ready(function() {
            // Botão para verificar o vídeo e obter resoluções disponíveis
            $('#check-video').on('click', function() {
                const url = $('#video-url').val();
                if (!url) return;
                
                // Desabilitar botão durante a verificação
                $(this).prop('disabled', true).text('Verificando...');
                
                // Obter informações do vídeo e resoluções disponíveis
                $.ajax({
                    url: '/check-video',
                    type: 'POST',
                    data: {url: url},
                    success: function(response) {
                        // Habilitar botão novamente
                        $('#check-video').prop('disabled', false).text('Verificar Vídeo');
                        
                        if (response.error) {
                            alert('Erro: ' + response.error);
                            return;
                        }
                        
                        // Preencher informações do vídeo
                        $('#video-title').text(response.title);
                        $('#thumbnail').attr('src', response.thumbnail);
                        
                        // Preencher opções de resolução
                        const select = $('#resolution-select');
                        select.empty();
                        
                        response.formats.forEach(function(format) {
                            select.append(`<option value="${format.format_id}">${format.resolution} - ${format.ext} (${format.filesize_approx})</option>`);
                        });
                        
                        // Mostrar container de resolução
                        $('#resolution-container').show();
                    },
                    error: function(xhr) {
                        $('#check-video').prop('disabled', false).text('Verificar Vídeo');
                        alert('Erro ao verificar vídeo: ' + xhr.responseText);
                    }
                });
            });
            
            // Formulário de download
            $('#download-form').on('submit', function(e) {
                e.preventDefault();
                
                const url = $('#video-url').val();
                const formatId = $('#resolution-select').val();
                
                if (!url || !formatId) return;
                
                // Mostrar barra de progresso
                $('#progress-container').show();
                $('#download-button').prop('disabled', true).text('Baixando...');
                
                // Iniciar o download e monitorar o progresso
                $.ajax({
                    url: '/download',
                    type: 'POST',
                    data: {
                        url: url,
                        format_id: formatId
                    },
                    success: function(response) {
                        if (response.download_id) {
                            checkProgress(response.download_id);
                        } else {
                            window.location.href = response.download_url;
                        }
                    },
                    error: function(xhr) {
                        $('#progress-container').hide();
                        $('#download-button').prop('disabled', false).text('Baixar Vídeo');
                        alert('Erro ao iniciar o download: ' + xhr.responseText);
                    }
                });
            });
            
            function checkProgress(downloadId) {
                $.ajax({
                    url: '/progress/' + downloadId,
                    type: 'GET',
                    success: function(data) {
                        // Atualizar a barra de progresso
                        $('#progress-title').text(data.title || 'Vídeo');
                        $('#download-progress').css('width', data.percent + '%');
                        $('#progress-percentage').text(data.percent + '%');
                        $('#progress-speed').text(data.speed);
                        
                        if (data.status === 'completed') {
                            // Download concluído
                            window.location.href = data.download_url;
                        } else if (data.status === 'error') {
                            // Erro no download
                            alert('Erro no download: ' + data.error);
                            $('#progress-container').hide();
                            $('#download-button').prop('disabled', false).text('Baixar Vídeo');
                        } else {
                            // Continuar verificando o progresso
                            setTimeout(function() {
                                checkProgress(downloadId);
                            }, 1000);
                        }
                    },
                    error: function() {
                        $('#progress-container').hide();
                        $('#download-button').prop('disabled', false).text('Baixar Vídeo');
                    }
                });
            }
        });
    </script>
</body>
</html>